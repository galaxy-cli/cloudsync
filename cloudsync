#!/bin/bash
#       _                 _                      
#   ___| | ___  _   _  __| |___ _   _ _ __   ___ 
#  / __| |/ _ \| | | |/ _` / __| | | | '_ \ / __|
# | (__| | (_) | |_| | (_| \__ \ |_| | | | | (__ 
#  \___|_|\___/ \__,_|\__,_|___/\__, |_| |_|\___|
#                               |___/            
# cloudsync - Dynamic & Verbose Cloud File Manager using rclone
# Author: galaxy-cli

# --- INITIALIZATION ---
SELECTED_REMOTES=()
SOURCE_PATH="" 
DEST_PATH=""
SELECTED_ACTION=""
VERBOSE=false

# --- FUNCTIONS ---

show_help() {
    cat << EOF
USAGE 
  cloudsync [ACTION] --cloud [REMOTES] --path [LOCAL] --dest [REMOTE_PATH]

ACTIONS
  --sync             Sync local to remote (matches destination to source)
  --copy             Copy local to remote (no deletions on remote)
  --remove           Delete a specific file from specified remotes
  --remove-dir       Delete an entire directory from specified remotes
  --make-dir         Create a new directory on specified remotes
  -l, --list         List files on the specified remotes
  -h, --help         Display this help menu

OPTIONS
  -c, --cloud        Comma-separated list of rclone remotes (e.g., "drive,mega")
  -p, --path         The local source path (for sync/copy)
  -d, --dest         The remote destination path
  -v, --verbose      Show the exact rclone commands being executed

EXAMPLE
  cloudsync --copy -v -c "Google Drive" -p ~/file.txt -d "Backups"
EOF
}

check_rclone() {
    if ! command -v rclone &> /dev/null; then
        echo "rclone not found. Installing now..."
        curl https://rclone.org/install.sh | sudo bash
        sudo rclone selfupdate --beta
    fi
}

# Helper to print command if verbose is on
log_command() {
    if [ "$VERBOSE" = true ]; then
        echo -e "\033[1;33m[COMMAND]:\033[0m $1"
    fi
}

execute_action() {
    local ACTION=$1
    check_rclone

    for REMOTE in "${SELECTED_REMOTES[@]}"; do
        REMOTE=$(echo "$REMOTE" | xargs)

        if ! rclone listremotes | grep -q "^$REMOTE:"; then
            echo "[SKIP] Remote '$REMOTE' not configured."
            continue
        fi

        case "$ACTION" in
            "sync")
                CMD="rclone sync \"$SOURCE_PATH\" \"$REMOTE:$DEST_PATH\" --progress"
                log_command "$CMD"
                eval "$CMD"
                ;;
            "copy")
                CMD="rclone copy \"$SOURCE_PATH\" \"$REMOTE:$DEST_PATH\" --progress"
                log_command "$CMD"
                eval "$CMD"
                ;;
            "remove")
                CMD="rclone deletefile \"$REMOTE:$DEST_PATH\""
                log_command "$CMD"
                eval "$CMD"
                ;;
            "remove-dir")
                CMD="rclone purge \"$REMOTE:$DEST_PATH\""
                log_command "$CMD"
                eval "$CMD"
                ;;
            "make-dir")
                CMD="rclone mkdir \"$REMOTE:$DEST_PATH\""
                log_command "$CMD"
                eval "$CMD"
                ;;
            "list")
                echo "--- $REMOTE ($DEST_PATH) ---"
                CMD="rclone ls \"$REMOTE:$DEST_PATH\""
                log_command "$CMD"
                eval "$CMD"
                ;;
        esac
    done
}

# --- ARGUMENT PARSING ---

if [[ $# -eq 0 ]]; then
    show_help
    exit 0
fi

while [[ $# -gt 0 ]]; do
    case "$1" in
        --sync)       SELECTED_ACTION="sync"; shift ;;
        --copy)       SELECTED_ACTION="copy"; shift ;;
        --remove)     SELECTED_ACTION="remove"; shift ;;
        --remove-dir) SELECTED_ACTION="remove-dir"; shift ;;
        --make-dir)   SELECTED_ACTION="make-dir"; shift ;;
        -l|--list)    SELECTED_ACTION="list"; shift ;;
        -p|--path)    SOURCE_PATH="$2"; shift 2 ;;
        -d|--dest)    DEST_PATH="$2"; shift 2 ;;
        -v|--verbose) VERBOSE=true; shift ;;
        -c|--cloud)   IFS=',' read -ra SELECTED_REMOTES <<< "$2"; shift 2 ;;
        -h|--help)    show_help; exit 0 ;;
        *) echo "Invalid option: $1"; show_help; exit 1 ;;
    esac
done

# --- VALIDATION ---

if [[ -z "$SELECTED_ACTION" ]]; then
    show_help
    exit 1
fi

if [[ ${#SELECTED_REMOTES[@]} -eq 0 ]]; then
    echo "Error: You must specify at least one remote using --cloud or -c."
    exit 1
fi

execute_action "$SELECTED_ACTION"
=======
# cloudsync - A simple Bash script to securely and selectively sync files to cloud services using rclone
# Author: galaxy-cli
# Project: https://github.com/galaxy-cli/tts

# Alias
# alias cloudsyncd='printf "Google Drive\n"; rclone ls Google\ Drive:; printf \nMEGA\n:; printf "\npCloud\n"; rclone ls pCloud:'

# --- CONFIGURATION ---
# The single source for everything (KeePassXC, Cryptomator Vault, etc.)
SOURCE_DIR="$HOME/Backup"

# Your cloud remotes (must match 'rclone config' names)
REMOTES=("Google Drive" "MEGA" "pCloud")

# Archive/Versioning Logic
TIMESTAMP=$(date +%Y-%m-%d_%H%M%S)

# --- DEPENDENCY CHECK ---
if ! command -v rclone &> /dev/null; then
    echo "rclone not found. Installing now..."
    curl https://rclone.org/install.sh | sudo bash
    sudo rclone selfupdate --beta 
fi

# --- PRE-FLIGHT CHECK ---
if [ ! -d "$SOURCE_DIR" ]; then
    echo "Error: Source directory $SOURCE_DIR not found!"
    echo "Please create it or update the SOURCE_DIR variable in this script."
    exit 1
fi

# --- EXECUTION ---
echo "Starting CloudSync at $(date)"
echo "---------------------------------------------------------"

for REMOTE in "${REMOTES[@]}"; do
    # Check if the remote is actually configured in rclone
    if ! rclone listremotes | grep -q "^$REMOTE:"; then
        echo "[SKIP] Remote '$REMOTE' not configured. Skipping..."
        continue
    fi

    echo "Syncing to $REMOTE..."

    # SYNC COMMAND
    # --backup-dir moves deleted/changed cloud files to an 'Archive' folder
    # so you never actually lose data if you delete something locally by mistake.
    rclone sync "$SOURCE_DIR" "$REMOTE:Backup/Current" \
        --backup-dir "$REMOTE:Backup/Archive/$TIMESTAMP" \
        --progress \
        --stats-one-line \
        --fast-list  # Optimizes for many files (good for Cryptomator)

    if [ $? -eq 0 ]; then
        echo "[SUCCESS] $REMOTE sync complete."
    else
        echo "[ERROR] $REMOTE sync encountered an issue."
    fi
    echo "---------------------------------------------------------"
done

echo "All tasks finished at $(date)."
