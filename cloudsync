#!/bin/bash
#       _                 _                      
#   ___| | ___  _   _  __| |___ _   _ _ __   ___ 
#  / __| |/ _ \| | | |/ _` / __| | | | '_ \ / __|
# | (__| | (_) | |_| | (_| \__ \ |_| | | | | (__ 
#  \___|_|\___/ \__,_|\__,_|___/\__, |_| |_|\___|
#                               |___/            
# cloudsync - A simple Bash script to securely and selectively sync files to cloud services using rclone
# Author: galaxy-cli
# Project: https://github.com/galaxy-cli/tts

# Alias
# alias cloudsyncd='printf "Google Drive\n"; rclone ls Google\ Drive:; printf \nMEGA\n:; printf "\npCloud\n"; rclone ls pCloud:'

# --- CONFIGURATION ---
# The single source for everything (KeePassXC, Cryptomator Vault, etc.)
SOURCE_DIR="$HOME/Backup"

# Your cloud remotes (must match 'rclone config' names)
REMOTES=("Google Drive" "MEGA" "pCloud")

# Archive/Versioning Logic
TIMESTAMP=$(date +%Y-%m-%d_%H%M%S)

# --- DEPENDENCY CHECK ---
if ! command -v rclone &> /dev/null; then
    echo "rclone not found. Installing now..."
    curl https://rclone.org/install.sh | sudo bash
    sudo rclone selfupdate --beta 
fi

# --- PRE-FLIGHT CHECK ---
if [ ! -d "$SOURCE_DIR" ]; then
    echo "Error: Source directory $SOURCE_DIR not found!"
    echo "Please create it or update the SOURCE_DIR variable in this script."
    exit 1
fi

# --- EXECUTION ---
echo "Starting CloudSync at $(date)"
echo "---------------------------------------------------------"

for REMOTE in "${REMOTES[@]}"; do
    # Check if the remote is actually configured in rclone
    if ! rclone listremotes | grep -q "^$REMOTE:"; then
        echo "[SKIP] Remote '$REMOTE' not configured. Skipping..."
        continue
    fi

    echo "Syncing to $REMOTE..."

    # SYNC COMMAND
    # --backup-dir moves deleted/changed cloud files to an 'Archive' folder
    # so you never actually lose data if you delete something locally by mistake.
    rclone sync "$SOURCE_DIR" "$REMOTE:Backup/Current" \
        --backup-dir "$REMOTE:Backup/Archive/$TIMESTAMP" \
        --progress \
        --stats-one-line \
        --fast-list  # Optimizes for many files (good for Cryptomator)

    if [ $? -eq 0 ]; then
        echo "[SUCCESS] $REMOTE sync complete."
    else
        echo "[ERROR] $REMOTE sync encountered an issue."
    fi
    echo "---------------------------------------------------------"
done

echo "All tasks finished at $(date)."
